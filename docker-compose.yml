# Cal.com Self-Hosted Room Booking Backend
# Run with: docker-compose up -d
version: "3.9"

services:
  cal:
    image: calcom/cal.com:latest
    container_name: shoeinn-booking
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      # Database
      - DATABASE_URL=postgresql://cal:${POSTGRES_PASSWORD:-shoeinn2024}@db:5432/cal
      
      # Authentication
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-generate-a-random-secret-here}
      - CALENDSO_ENCRYPTION_KEY=${CALENDSO_ENCRYPTION_KEY:-generate-32-char-key}
      - NEXTAUTH_URL=http://localhost:3001
      
      # Stripe (configure with your keys)
      - STRIPE_API_KEY=${STRIPE_API_KEY:-sk_test_xxx}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-whsec_xxx}
      - PAYMENT_FEE_PERCENTAGE=0
      - PAYMENT_FEE_FIXED=0
      
      # Email (configure with your SMTP)
      - EMAIL_FROM=${EMAIL_FROM:-bookings@theshoeinn.co.uk}
      - EMAIL_SERVER_HOST=${EMAIL_SERVER_HOST:-smtp.gmail.com}
      - EMAIL_SERVER_PORT=${EMAIL_SERVER_PORT:-587}
      - EMAIL_SERVER_USER=${EMAIL_SERVER_USER:-}
      - EMAIL_SERVER_PASSWORD=${EMAIL_SERVER_PASSWORD:-}
      
      # App Settings
      - NEXT_PUBLIC_WEBAPP_URL=http://localhost:3001
      - NEXT_PUBLIC_LICENSE_CONSENT=agree
      - CALCOM_TELEMETRY_DISABLED=1
    depends_on:
      db:
        condition: service_healthy
    networks:
      - shoeinn-network

  db:
    image: postgres:15-alpine
    container_name: shoeinn-booking-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=cal
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-shoeinn2024}
      - POSTGRES_DB=cal
    volumes:
      - cal_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cal -d cal"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shoeinn-network

volumes:
  cal_postgres_data:
    driver: local

networks:
  shoeinn-network:
    driver: bridge

